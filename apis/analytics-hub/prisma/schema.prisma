// Analytics Hub - Real-time Analytics & Metrics API
// Prisma Schema for event tracking, dashboards, and insights

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// API Key for authentication
model ApiKey {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  projectId   String
  permissions String   @default("read,write") // comma-separated: read,write,admin
  rateLimit   Int      @default(1000) // requests per hour
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events      Event[]
  usageLogs   UsageLog[]
}

// Project/App using Analytics Hub
model Project {
  id          String   @id @default(uuid())
  name        String
  domain      String?  // allowed domain for CORS
  description String?
  settings    String   @default("{}") // JSON settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  apiKeys     ApiKey[]
  events      Event[]
  dashboards  Dashboard[]
  funnels     Funnel[]
  alerts      Alert[]
}

// Individual analytics event
model Event {
  id          String   @id @default(uuid())
  projectId   String
  apiKeyId    String?

  // Event identification
  name        String   // e.g., "page_view", "button_click", "purchase"
  category    String   @default("general") // e.g., "user", "commerce", "engagement"

  // User/session tracking
  userId      String?  // optional user identifier
  sessionId   String?  // session identifier
  anonymousId String?  // anonymous tracking ID

  // Event data
  properties  String   @default("{}") // JSON properties
  value       Float?   // numeric value (e.g., purchase amount)

  // Context
  source      String?  // e.g., "web", "mobile", "api"
  referrer    String?
  userAgent   String?
  ipAddress   String?
  country     String?
  city        String?
  device      String?  // e.g., "desktop", "mobile", "tablet"
  browser     String?
  os          String?

  // Timestamps
  timestamp   DateTime @default(now())
  receivedAt  DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  apiKey      ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([projectId, name])
  @@index([projectId, timestamp])
  @@index([projectId, userId])
  @@index([projectId, sessionId])
  @@index([name, timestamp])
}

// Real-time metrics aggregation (pre-computed for performance)
model MetricSnapshot {
  id          String   @id @default(uuid())
  projectId   String

  // Time bucket
  period      String   // "minute", "hour", "day", "week", "month"
  bucketStart DateTime
  bucketEnd   DateTime

  // Metrics
  metricName  String   // e.g., "total_events", "unique_users", "page_views"
  metricValue Float
  dimensions  String   @default("{}") // JSON for breakdown dimensions

  createdAt   DateTime @default(now())

  @@unique([projectId, period, bucketStart, metricName, dimensions])
  @@index([projectId, period, bucketStart])
  @@index([metricName, bucketStart])
}

// Custom dashboard configuration
model Dashboard {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  layout      String   @default("[]") // JSON layout configuration
  isPublic    Boolean  @default(false)
  publicSlug  String?  @unique // for public sharing
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  widgets     Widget[]
}

// Dashboard widget
model Widget {
  id          String   @id @default(uuid())
  dashboardId String

  name        String
  type        String   // "line_chart", "bar_chart", "pie_chart", "number", "table", "funnel"
  config      String   @default("{}") // JSON widget configuration
  query       String   // Query definition (metrics, filters, grouping)
  position    String   @default("{}") // JSON position in grid
  refreshRate Int      @default(60) // seconds

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
}

// Conversion funnel
model Funnel {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  steps       String   // JSON array of funnel steps [{name, event, filters}]
  timeWindow  Int      @default(86400) // seconds to complete funnel (default 24h)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// Metric alerts
model Alert {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?

  // Alert condition
  metric      String   // metric to monitor
  condition   String   // "gt", "lt", "eq", "gte", "lte", "change_percent"
  threshold   Float
  timeWindow  Int      @default(3600) // evaluation window in seconds

  // Notification
  channels    String   @default("[]") // JSON array of notification channels
  cooldown    Int      @default(3600) // minimum seconds between alerts

  isActive    Boolean  @default(true)
  lastTriggeredAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// Alert history
model AlertHistory {
  id          String   @id @default(uuid())
  alertId     String

  triggeredAt DateTime @default(now())
  metricValue Float
  threshold   Float
  message     String
  notified    Boolean  @default(false)

  @@index([alertId, triggeredAt])
}

// API usage logging
model UsageLog {
  id          String   @id @default(uuid())
  apiKeyId    String
  endpoint    String
  method      String
  statusCode  Int
  responseTime Int     // milliseconds
  timestamp   DateTime @default(now())

  apiKey      ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, timestamp])
}

// Feature flags
model FeatureFlag {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isEnabled   Boolean  @default(false)
  percentage  Int      @default(100) // rollout percentage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
