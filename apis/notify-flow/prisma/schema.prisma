// NotifyFlow - Unified Multi-Channel Notification API
// Prisma Schema for notifications, templates, channels, and delivery tracking

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// API Key for authentication
model ApiKey {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  projectId   String
  permissions String   @default("read,write") // comma-separated: read,write,admin
  rateLimit   Int      @default(1000) // requests per hour
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// Project/App using NotifyFlow
model Project {
  id          String   @id @default(uuid())
  name        String
  settings    String   @default("{}") // JSON settings (default from, reply-to, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  apiKeys     ApiKey[]
  channels    Channel[]
  templates   Template[]
  notifications Notification[]
  subscribers Subscriber[]
}

// Notification channel configuration
model Channel {
  id          String   @id @default(uuid())
  projectId   String

  name        String   // e.g., "Primary Email", "Slack Alerts"
  type        String   // "email", "webhook", "sms", "push", "slack"
  config      String   @default("{}") // JSON config (SMTP settings, webhook URL, etc.)
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)

  // Rate limiting per channel
  rateLimit   Int      @default(100) // per hour

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([projectId, name])
}

// Notification template
model Template {
  id          String   @id @default(uuid())
  projectId   String

  name        String   // e.g., "welcome_email", "password_reset"
  description String?

  // Template content (Handlebars syntax)
  subject     String?  // For email
  body        String   // Main content (HTML for email, text for others)
  bodyText    String?  // Plain text version for email

  // Template variables schema (JSON)
  variables   String   @default("[]") // Expected variables with defaults

  // Channel targeting
  channelType String   @default("email") // Which channel type this template is for

  isActive    Boolean  @default(true)
  version     Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([projectId, name])
}

// Individual notification
model Notification {
  id          String   @id @default(uuid())
  projectId   String
  channelId   String?
  templateId  String?

  // Recipient
  recipient   String   // Email, phone, webhook URL, device token
  recipientType String @default("email") // "email", "phone", "webhook", "device"

  // Content (overrides template if provided)
  subject     String?
  body        String?
  data        String   @default("{}") // JSON data for template variables

  // Metadata
  metadata    String   @default("{}") // Custom metadata (user_id, order_id, etc.)
  tags        String   @default("[]") // JSON array of tags for filtering

  // Scheduling
  scheduledFor DateTime?

  // Status tracking
  status      String   @default("pending") // "pending", "queued", "sending", "sent", "delivered", "failed", "bounced"

  // Delivery tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  failedAt    DateTime?

  // Error handling
  errorMessage String?
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)

  // Priority
  priority    Int      @default(5) // 1 (highest) to 10 (lowest)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  channel     Channel?  @relation(fields: [channelId], references: [id], onDelete: SetNull)
  template    Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  events      NotificationEvent[]

  @@index([projectId, status])
  @@index([projectId, recipient])
  @@index([status, scheduledFor])
  @@index([createdAt])
}

// Notification delivery events
model NotificationEvent {
  id             String   @id @default(uuid())
  notificationId String

  type           String   // "queued", "sent", "delivered", "opened", "clicked", "bounced", "failed", "unsubscribed"
  data           String   @default("{}") // Event-specific data

  timestamp      DateTime @default(now())

  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId, timestamp])
}

// Subscriber management (opt-in/out)
model Subscriber {
  id          String   @id @default(uuid())
  projectId   String

  email       String?
  phone       String?
  deviceToken String?
  externalId  String?  // External user ID from your app

  // Preferences
  preferences String   @default("{}") // JSON preferences (channels, frequency, topics)

  // Status
  status      String   @default("active") // "active", "unsubscribed", "bounced", "complained"

  // Metadata
  metadata    String   @default("{}") // Custom subscriber data
  tags        String   @default("[]") // JSON array of tags

  unsubscribedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, email])
  @@index([projectId, status])
  @@index([projectId, externalId])
}

// Scheduled/recurring notifications
model Schedule {
  id          String   @id @default(uuid())
  projectId   String

  name        String
  description String?

  // Cron expression or one-time schedule
  cronExpression String?   // e.g., "0 9 * * 1" (every Monday at 9am)
  timezone    String   @default("UTC")

  // Template and recipient config
  templateId  String
  recipientQuery String @default("{}") // JSON query to select subscribers
  data        String   @default("{}") // Static data for template

  isActive    Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, nextRunAt])
}

// Feature flags
model FeatureFlag {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isEnabled   Boolean  @default(false)
  percentage  Int      @default(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
